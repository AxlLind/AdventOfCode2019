use std::time::Instant;
use std::collections::{HashMap, HashSet, VecDeque};
use itertools::Itertools;

const INPUT: [&str; 129] = [
  "                                               A U       K     C   I         L   Q           W                                         ",
  "                                               V H       F     D   F         Z   S           E                                         ",
  "  #############################################.#.#######.#####.###.#########.###.###########.#######################################  ",
  "  #...#.#.........#.#.......#...#.#.....#.....#.#.....#.........#.......#...#.#.#.....#.#.#.....#...#...#.#.#...........#.....#.#.#.#  ",
  "  ###.#.#####.#.###.#######.###.#.###.#####.#.#.#####.#######.###.#########.#.#.#.#####.#.###.###.#.###.#.#.###.#.#.###.#.#####.#.#.#  ",
  "  #.#...#.#.#.#.#.........#.................#.....#.#.......#...#...#.......#...#...#.#.#.........#.............#.#.#.#.#...#.......#  ",
  "  #.#.###.#.#.#######.###.#.###.###.#.###.#.#.#.###.###.#####.###.#########.###.#.###.#.#####.#######.###.###.#######.###.###.#######  ",
  "  #...#.......#.......#.....#.....#.#.#.#.#.#.#.#.....#...#.....#...#.#.........#.....#...#.#.....#.#.#.#...#...#.....#.....#.......#  ",
  "  ###.#######.###########.###.#.#######.#.#######.###.#.#######.#.###.###.#########.###.###.#.#####.###.#.###.#####.###.#.###.#.#####  ",
  "  #...........#.#.#.........#.#...#...#...#.......#.....#.......#.#...#.#.....#.....#.......#.......#.#...#.............#.....#.....#  ",
  "  #.#.#######.#.#.#.#.#####.#######.#####.#####.#.#########.#.#.#.#.#.#.#.#.#.###.#.#####.#.#.#######.###.#####.#####.#.#############  ",
  "  #.#.#.#.#.........#.#.......#...#...........#.#.#...#.....#.#.#...#...#.#.#...#.#.#.....#.............#.....#.....#.#.#.#.......#.#  ",
  "  #####.#.###.#####.#############.###.###.#######.#.#.###.#####.#######.#####.#.#.###.#.#.#.#.#####.#####.#.###.#####.#.#.#####.###.#  ",
  "  #.........#.#.#...#...#.#.#...#.#.#.#.....#.......#...#.....#.#.........#.#.#.#...#.#.#.#.#.#.#...#.#...#.#.......#.#...#.....#...#  ",
  "  #######.#####.#.#.###.#.#.#.#.#.#.#####.###.###.###.#.#.#######.#######.#.###.###.###.#######.###.#.#####.###.#.#######.#####.###.#  ",
  "  #.#.......#...#.#.#.......#.#.#...........#.#.#...#.#.#...#.......#.#.#.#.#...#...#...#.........#.#...#.....#.#.#.#.#.#.#.#...#...#  ",
  "  #.#.#.#.#####.#########.#####.#####.#.#.#####.#.#####.#.###.###.###.#.###.#.###.#####.#.###########.#####.#######.#.#.###.#.###.###  ",
  "  #...#.#.#...#.....#.#.....#...#.#...#.#...#.....#.....#.#.....#.........#.....#.....#...#.............#.#.#.#.#.#...#.#.#.....#.#.#  ",
  "  #######.###.#.#####.#.#.#.###.#.#####.###.###.#.#####.#.#######.#.#.#.#####.#.#.#.#.#.#.#.###.###.#.#.#.###.#.#.#.###.#.###.###.#.#  ",
  "  #.#...................#.#.........#...#.#...#.#...#...#.....#...#.#.#...#...#.#.#.#.#.#.#.#.....#.#.#.......#.#...#.#.#...#.......#  ",
  "  #.#.###.#####.#.#.###########.#.###.###.#.#####.#.###.#.#########.###.#######.#.#.###.###.###.###########.###.#.###.#.#.###.#.#.###  ",
  "  #...#.#.#.....#.#.#...#.#.....#.#.#.#.#.......#.#.#.#.#.....#.#...#.....#...#.#.#.#.....#...#.#.#.#.#.#...#.#.....#.#.#...#.#.#.#.#  ",
  "  #####.#.###.#.#####.#.#.#######.#.###.#.#.###.#####.#.#####.#.#######.###.###.#.#####.###.#####.#.#.#.#####.#.###.#.#.#.###.#####.#  ",
  "  #.......#.#.#.#.#.#.#.#...#.............#.#...#.....#.#.........#.......#.....#.....#...........#.#.#.......#.#.#.......#.#.......#  ",
  "  #########.#####.#.###.###.###.#.#.#####.#######.#####.#.#####.#######.#####.#.#.#######.#.###.###.#.#.#########.#######.#.###.#####  ",
  "  #.....#...#...#...#...#.#...#.#.#.#.#.....#.........#.#...#.#.#...#.#.#.#...#.#.#.......#...#.............#...#.#.........#.#.....#  ",
  "  #.#.#####.###.#.###.###.###.#.#.###.#####.###.#.###.#.###.#.#####.#.#.#.#####.#.#####.#.#.#.#.###.#.#########.#.###.#.#.###.#.#####  ",
  "  #.#...#.....#.#.........#.....#.#...........#.#.#...#.#...........#...#.......#.#.....#.#.#.#.#.#.#.....#.#...#...#.#.#.......#.#.#  ",
  "  ###.#####.#.#.#####.#.#.###.###.###.#.#.###.###.#.###.#.#####.#######.#.#####.#.#####.#.#####.#.#####.###.###.#.#####.###.#.###.#.#  ",
  "  #.......#.#.#.#...#.#.#.#.....#.#...#.#.#...#...#.#...#.#...#.#.....#.#.....#.#.....#.#.#...#...#.#.#...#.#.........#.#.#.#.....#.#  ",
  "  ###.#######.#.###.#####.###.#########.#.#######.#.#.###.#.#.###.###.#.#.###.###.#####.###.###.###.#.#####.#.#####.#####.#####.###.#  ",
  "  #.#...#.#.....#.....#.....#.#.........#.....#...#.#...#...#.#...#.#.#.#.#.....#...#.........#.#.#.#...#...#.#.#.#.#.#.#...........#  ",
  "  #.#.###.###.#.#####.###.#############.#.#.#####.#.###.###.#####.#.#.#.#######.#.#######.#.#####.#.#.#####.###.#.#.#.#.###.###.#####  ",
  "  #...#.#.#...#...#.#.#.#.......#.....#.#.#.#.....#.#...#.......#.#.#.....#.#...#.#.......#.#...#.#...#.#.#...#.#.#...#.#.#.#.......#  ",
  "  ###.#.#.#.#######.#.#.###.#######.#####.#####.#.#.#.#.#.#######.#########.#.#.#.#####.#####.###.#.###.#.#.###.#.#.###.#.###.#.#####  ",
  "  #...#.....#.#.#...#...#.#.#.#.#...........#...#.#...#.#.......#...#.........#.#.....#.........#.......#.#...#...#...#...#.#.#.....#  ",
  "  #.#.#####.#.#.###.#.###.#.#.#.#.#######.#######.#########.#.###.#######.###########.#######.#####.#.###.#.#####.#.#####.#.###.#####  ",
  "  #.#...#...#.#.#.....#.......#.#...#    E       S         Z J   C       A           R       X    #.#...#...#.......#.#.#.#.#.....#.#  ",
  "  ###.#####.#.#.###.#######.###.#####    L       Y         M G   D       U           D       A    #.#######.#####.###.#.#.#.#####.#.#  ",
  "  #.#.#.#.....#.#...#...#.....#.#...#                                                             #.......#...#.....#.#...#...#......XA",
  "  #.#.#.###.###.###.#.#####.###.###.#                                                             #.###.#.#.#.#.###.#.#.#.#.#.#.#.#.#  ",
  "  #.............#.....#.......#.....#                                                           WC..#...#.#.#.#...#.....#...#...#.#.#  ",
  "  #.#.###.###.###.###.###.###.#.###.#                                                             ###.#.###.#####.#######.###.###.#.#  ",
  "RD..#...#.#.......#.....#...#...#.#.#                                                             #...#.#...#...#.#...#...#...#...#.#  ",
  "  #.#########.###.###.#.###.#.#.#.#.#                                                             ###.###.#.#.#.#.#.#########.#####.#  ",
  "  #...#.....#...#...#.#.....#.#.#...#                                                             #.......#...#.....#.....#.....#...#  ",
  "  #.#####.#######.#.###.###.#.#.#.###                                                             #.#############.###.#############.#  ",
  "  #.#...#.#.....#.#.#.#.#.#.#.#.#....UZ                                                           #.#.........#.#.#.#.#.#.#.....#.#.#  ",
  "  #####.#.#.#######.#.###.#.#.#####.#                                                             ###.#######.#.#.#.#.#.#.#.#.###.###  ",
  "  #.....#.....#...#.#.#...#.#...#...#                                                           TR..#.#...#.....#...#...#.#.#.#.#...#  ",
  "  #.###.#.#######.#.#.###.###.#######                                                             #.#.#.#.#.#.#.###.#.###.###.#.###.#  ",
  "ZM....#.......#.#.#.#.#.....#.#.#...#                                                             #.#.#.#...#.#...#.#................EL",
  "  ###.###.#####.#.###.###.#.###.###.#                                                             #.#.#.#############.#########.#.#.#  ",
  "  #...#.#...#.......#.....#.........#                                                             #...#...............#.......#.#.#.#  ",
  "  ###.#.#.#####.###.#.###.#.#######.#                                                             #.#.#######################.#######  ",
  "  #.#.#.#.......#.......#.#.....#....UH                                                           #.#.#.........#.....#.#...#...#.#..AU",
  "  #.###.#############################                                                             #######.###.#####.###.#.###.#.#.#.#  ",
  "  #.......#.............#...........#                                                           TZ..........#.................#......ZZ",
  "  #.#####.#.#.#.#.###.#####.#.#.###.#                                                             ###################.#.#####.#.#####  ",
  "  #.....#...#.#.#.#.#...#.#.#.#...#..WT                                                         ET..#.#.......#.#...#.#.....#.#.#...#  ",
  "  #####.###.#.#######.###.#.#.#####.#                                                             #.#.#.###.###.#.###############.###  ",
  "  #.....#...#...#.....#.....#...#...#                                                             #.#...#.........#.#.#.....#.#......TZ",
  "  #.#.#.#.#.#######.###.###.#########                                                             #.#.###.#.###.###.#.#.#.#.#.#.#.###  ",
  "TR..#.#.#.#...#.........#.....#.....#                                                             #.#.#...#...#.#.#.....#.#.#...#.#.#  ",
  "  #############.###.###########.#####                                                             #.#.#.#########.#####.#.#####.###.#  ",
  "  #...#...#...#.#...#...........#.#.#                                                             #...#.................#...........#  ",
  "  #.#.#.#.###.###.#####.#.###.###.#.#                                                             #.#################################  ",
  "WT..#...#.....#...#.#...#.#...#.#...#                                                             #.#.......#...#...#...............#  ",
  "  #.###.#.###.#####.###.###.###.###.#                                                             ###.###.###.#.###.#.#.#.#.#####.#.#  ",
  "  #.#...#.#.....#...#...#.#.......#.#                                                           QS..#.#.#.....#.......#.#.#.#.....#.#  ",
  "  #####.#.###.#####.#.#.#.#######.#.#                                                             #.#.#.#####.###.#.#.#########.###.#  ",
  "  #...#.#.#...........#.#.#.#.#......WE                                                           #.#.......#.#.#.#.#.#.......#.#.#..JG",
  "  #.#######.###.#.#######.#.#.#######                                                             #.#######.###.#####.#####.#####.#.#  ",
  "  #.....#...#...#.#.#.......#.......#                                                             #.............#.#.#.#.#...#...#...#  ",
  "  #.#.#.#######.#.#.###.###.###.###.#                                                             ###.###########.#.###.###.###.#####  ",
  "UZ..#.#.#.#...#.#.#.#...#...#...#...#                                                           XR..#.#...........#.#.#.#...........#  ",
  "  ###.###.#.#.#.###.###.#.###.#.###.#                                                             #.###.###.#####.#.#.#.###.#.###.###  ",
  "  #.....#...#.#.#.....#.#...#.#.#.#..AQ                                                           #.#...#.....#.............#.#......WC",
  "  ###.###.#.#####.###.#.###.###.#.###                                                             #.###.###.#######.#.#.#.###.#.###.#  ",
  "  #.#.....#.........#...#.........#.#                                                             #.#.#.#.#.#.......#.#.#...#.#.#.#.#  ",
  "  #.#########.###.#####.###.###.###.#                                                             #.#.#.#.#######################.###  ",
  "  #.......#.....#.....#...#.#.#...#..LS                                                           #.......#.#.......#.....#...#.#.#.#  ",
  "  #.###.#################.#.#.#####.#                                                             #######.#.#.#######.#####.###.#.#.#  ",
  "  #.#.......#.#...#.#.#...#.#.......#                                                             #.#.#.#.#...#.........#.........#.#  ",
  "  #.#.#######.###.#.#.#######.###.#.#                                                             #.#.#.###.#.#.#######.#.#.#.###.#.#  ",
  "SY..#.....#.#.....#...#.#...#.#.#.#.#                                                           ER..........#.#.#.#.#.....#.#.#...#..XR",
  "  ###.#.###.#.###.###.#.#.#####.###.#                                                             #.#####.###.#.#.#.#.###.#######.#.#  ",
  "  #...#.......#.....................#                                                             #.#.#...#...#.....#.#.#.#.#.....#.#  ",
  "  #######.###.#######.#.#.###.#.#.#.#                                                             #.#.#######.###.#.###.#.#.#####.#.#  ",
  "  #.........#.....#...#.#.#.#.#.#.#.#                                                             #.....#.#.......#.#...........#...#  ",
  "  #.#####.#.#######.#.#.#.#.#####.#.#        L         E         I       K       N     A          #.#####.###.#.###.#.#####.#######.#  ",
  "  #...#.#.#...#.#...#.#.#.....#.#.#.#        Z         M         F       F       T     V          #...#.......#...#.#...#.......#...#  ",
  "  #####.#.###.#.###.#.#.#.#.#.#.#############.#########.#########.#######.#######.#####.#################.#.###.#.#####.#.###.#####.#  ",
  "  #.......#.......#.#.#.#.#.#.....#...#...........#.#...#.#.......#.#.#.........#...#.......#...#.#.....#.#.#.#.#.....#.#.#.....#...#  ",
  "  #.###.#.#.#.#####.###.###.#.#.#.###.#.#####.#.###.#.#.#.###.#####.#.#####.#.#####.#######.#.###.###.#######.#.#.#######.#####.#.#.#  ",
  "  #.#...#.#.#.....#.#.....#.#.#.#...#...#.#...#.....#.#.#.....#.....#.......#.#.#.#.#.....#...#.....#.#.#.......#.#.#.........#.#.#.#  ",
  "  #####.#.###.###.#.###.###.#.#.#########.#.#.#.###.#.#######.#.#.#.#.#.#.#.###.#.#.###.#.#.#####.###.#.#####.###.#.#####.#####.###.#  ",
  "  #...#.#.#.....#.#.#.....#.#.#.#.#.....#...#.#.#...#...#...#.#.#.#.#.#.#.#.#.#.#...#...#.................#...#.........#.#.......#.#  ",
  "  #.#.#.#.###.#####.#.#.#.###.#.#.#.#.#########.###.#.#####.#.#.#.#######.###.#.#.###.#####.#####.#.#.###.###.#.#####.#######.#.###.#  ",
  "  #.#...#.#.....#...#.#.#...#.#...#.#.....#.....#...#.#.#.......#...#.#.#...#.......#.#.#.#...#.#.#.#.#.....#.#.....#...#.....#...#.#  ",
  "  #.###.#.#.#.#.###.###.#######.#######.#.#.###.###.#.#.###########.#.#.#.###.#######.#.#.#####.###########.#####.###.#########.###.#  ",
  "  #.#...#.#.#.#...#.#.....#.....#.#.....#.#...#.#...#.#.....#.......#.......#...#.................#...#.....#.......#.#.#.#.#.....#.#  ",
  "  #####.###.#.###.#####.#.###.#.#.#######.#########.#.#.###.###.#####.#######.#.###.#.###.###.###.#.###########.#.#.###.#.#.#.#####.#  ",
  "  #.....#.#.#.#.#.#.#...#.#.#.#.#.#.#.........#.#.#.#.#.#.#.#.......#.#.....#.#.#...#.#...#.....#.#...#...#.#...#.#.........#...#...#  ",
  "  #.###.#.#####.#.#.#.#.#.#.#####.#.#####.###.#.#.#.#.#.#.#.#####.#.#.#.#.###.###.###.###.#########.#.#.###.###.###.#####.###.###.###  ",
  "  #.#.......#.......#.#.#.#...#...........#.........#.....#.#.#.#.#.#.#.#.#.#...#...#.#...........#.#.#.......#.#.#.....#...#.#...#.#  ",
  "  #####.#.#####.###.###.###.#####.#.#.#.#.#######.#########.#.#.###.#.#.#.#.#.#.###.#.#####.#####.#.#####.#.#####.#.#####.#.#####.#.#  ",
  "  #.....#.#...#...#.#...#.....#...#.#.#.#...#.#.....#.............#.#...#...#.#.#.#.#.....#.....#.........#...#.........#.#.....#...#  ",
  "  #.#.#.#.###.#####.#########.#####.#########.#####.#.###.#####.###.###.#.###.###.#########.###.#.#######.###.###.###.#.#.#.###.#.#.#  ",
  "  #.#.#.#.#...............#.......#...#...#...#.#...#.#.#...#...#.....#.#...#.#.........#.....#.#.....#...#.....#...#.#.#.#.#.#.#.#.#  ",
  "  #.#.###.#.#.###.#.###.#.#####.#######.#####.#.###.#.#.###.#######.#######.#.#####.#.###.#.#####.###.#######.#.#.#.#.#.#####.###.###  ",
  "  #.#.#.#.#.#...#.#.#...#.#.........#.....#...#.....#.....#.#...#...#.#.#...#.#.#...#.#.#.#.....#...#.#...#...#.#.#.#.#.........#...#  ",
  "  #.###.#.###.#.###.###.###.###.###.#####.###.#.#######.#######.#.###.#.###.#.#.###.###.###.#####.#######.###.###.###.###.#.#.###.#.#  ",
  "  #.#.......#.#.#.....#...#.#.#.#...#.#...#.........#...#.#.#...#.....#.#...#...........#.......#.#.........#.#.#.#.....#.#.#.#...#.#  ",
  "  #.###.###.#.###.#.#########.#####.#.#.#####.###.###.###.#.###.###.###.###.#.#####.#.#.#.###.###.###.#.###.###.#######.#.###.###.###  ",
  "  #.#...#...#.#...#...#.#...#.................#.#.#.......#.......#...#.....#.#.#.#.#.#.#.#.#.#.......#.#.#...#.#...#...#.#...#.....#  ",
  "  #.#.#.#.#.###.###.###.###.#######.###.#.#.#.#.#.#####.#####.###.#.#######.#.#.#.#.#####.#.#.###.#.#####.#####.#.#######.#.#####.###  ",
  "  #.#.#.#.#.#.....#...#...#.#.......#...#.#.#...#.#.#...#.#...#.#...#...#...#.#.........#...#...#.#...#...#.#.....#...#...#...#.....#  ",
  "  #####.#######.###.###.###.#.#.#######.#######.###.#.#.#.###.#######.#.#.#####.#.#.#######.#######.#####.#.###.#####.#############.#  ",
  "  #.....#.......#.#.#.........#.#.#.....#...#.......#.#.#.#.#.#...#...#.#.....#.#.#.#.#...#.#.#.#...#...#.#.........#.....#.#...#.#.#  ",
  "  ###.#######.#.#.#####.#########.###.#.###.###.###.#.###.#.#.#.#.#.#.#.###.#####.###.###.#.#.#.#######.#.#.#.#.#.###.#####.#.###.###  ",
  "  #.....#...#.#.#...........#.........#.#.......#...#.#.....#...#.#.#.#...#.#.......#.#.#.....#.#...#.......#.#.#.#.#...............#  ",
  "  #.#####.#######.#.###.#.#####.###.###.#####.###.###.#.#####.#######.###.#.#.#######.#.#.###.#.###.#.#############.#.#.###.#######.#  ",
  "  #...#...........#...#.#...#...#.#.#.#.#.#.#.#.....#...#.#.#.....#.....#...#.....#.#.......#.....#...#...#...#...#...#...#...#.....#  ",
  "  #.#.#.#####.#####.###.#.###.###.###.#.#.#.#####.#####.#.#.#.#########.#####.#.#.#.#.#.#.#####.###.###.###.###.#####.###.###.###.###  ",
  "  #.#.#...#.....#...#...#.#.....#.......#.........#.......#.......#.........#.#.#...#.#.#.....#.......................#.....#.#.....#  ",
  "  ###############################################.#######.#####.#########.#######.#.#.###############################################  ",
  "                                                 A       L     N         E       A E E                                                 ",
  "                                                 Q       S     T         R       A M T                                                 ",
];
const W: usize = INPUT.len();
const H: usize = INPUT[0].len();

enum EdgeType { Outer, Inner, Normal }

type Graph = HashMap<(usize,usize), Vec<((usize,usize), EdgeType)>>;

fn create_graph(map: &[Vec<char>]) -> Graph {
  (0..W).cartesian_product(0..H)
    .filter(|&(i,j)| map[i][j] == '.')
    .map(|(i,j)| {
      let neighbours = [(i-1,j), (i+1,j), (i,j-1), (i,j+1)].iter()
        .filter(|&&(x,y)| map[x][y] == '.')
        .map(|&pos| (pos, EdgeType::Normal))
        .collect();
      ((i,j), neighbours)
    })
    .collect()
}

fn find_portals(map: &[Vec<char>]) -> Vec<(String, usize, usize)> {
  let mut portals = Vec::new();
  for i in 1..(W-1) {
    for j in 1..(H-1) {
      let from = map[i][j];
      if !from.is_ascii_uppercase() { continue; }
      let neighbours = [
        (map[i-1][j], i-1, j),
        (map[i+1][j], i+1, j),
        (map[i][j-1], i, j-1),
        (map[i][j+1], i, j+1),
      ];
      if let Some(&(_,x,y)) = neighbours.iter().find(|(c,_,_)| *c == '.') {
        let to = neighbours.iter().find(|(c,_,_)| c.is_ascii_uppercase()).unwrap().0;
        let name = [from, to].iter().sorted().collect();
        portals.push((name, x, y));
      }
    }
  }
  portals
}

fn connect_portals(
  g: &mut Graph,
  portals: &[(String, usize, usize)],
  max_x: usize,
  max_y: usize
) {
  for index in 0..portals.len() {
    let (p1, x, y) = &portals[index];
    let o = portals.iter().find(|(p2,x2,y2)| p1 == p2 && x != x2 && y != y2);
    if let Some(&(_,i,j)) = o {
      let t = if i == 2 || j == 2 {
        EdgeType::Inner
      } else if i == max_x || j == max_y {
        EdgeType::Inner
      } else {
        EdgeType::Outer
      };
      g.get_mut(&(*x,*y)).unwrap().push(((i,j), t));
    }
  }
}

fn bfs(
  graph: &Graph,
  (x, y): (usize,usize),
  end: (usize,usize),
) -> usize {
  let mut visited = HashSet::new();
  let mut queue = VecDeque::new();
  queue.push_back((x,y,0,0));
  loop {
    let (ux, uy, level, len) = queue.pop_front().unwrap();
    if level == 0 && (ux,uy) == end { return len; }
    visited.insert((ux, uy, level));

    for ((x,y), t) in &graph[&(ux,uy)] {
      let new_level = match t {
        EdgeType::Outer => {
          if level == 0 { continue; }
          level - 1
        },
        EdgeType::Inner => {
          if level > 25 { continue; }
          level + 1
        },
        EdgeType::Normal => level,
      };
      let v = (*x,*y,new_level);
      if visited.contains(&v) { continue; }
      queue.push_back((*x, *y, new_level, len+1));
    };
  }
}

fn main() {
  let now = Instant::now();
  let map = INPUT.iter().map(|s| s.chars().collect_vec()).collect_vec();
  let mut g = create_graph(&map);
  let portals = find_portals(&map);
  connect_portals(&mut g, &portals, W-3, H-3);

  let (_,x1,y1) = *portals.iter().find(|(p,_,_)| p == "AA").unwrap();
  let (_,x2,y2) = *portals.iter().find(|(p,_,_)| p == "ZZ").unwrap();

  let answer = bfs(&g, (x1,y1), (x2,y2));

  println!("Answer: {}", answer);
  println!("Time: {}ms", now.elapsed().as_millis());
}
